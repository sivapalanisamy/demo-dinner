{% comment %}
    Renders a product card

    Accepts:
    - product_card_product: {Object} Product Liquid object (optional)
    - media_size: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
    - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
    - add_image_padding: {Boolean} Enables padding on the image to space out the grid
    - show_vendor: {Boolean} Show the product vendor. Default: false
    - show_image_outline: {Boolean} Show card outline. Default: true (optional)
    - show_rating: {Boolean} Show the product rating. Default: false

    Usage:
{% render 'product-card', show_vendor: section.settings.show_vendor %}
{% endcomment %}

{{ 'component-rating.css' | asset_url | stylesheet_tag }}

<div class="card-wrapper">
    <div class="card-information">
        <div class="card-information__wrapper">
            {%- if show_vendor -%}
                <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
                <div class="caption-with-letter-spacing light">{{ product_card_product.vendor }}</div>
            {%- endif -%}

            {%- if product_card_product.featured_media -%}
                <h3 class="card-information__text h5">
                    <a href="{{ product_card_product.url | default: '#' }}" class="full-unstyled-link">
                        {{ product_card_product.title | escape }}
                    </a>
                </h3>
            {%- endif -%}

            {% comment %} TODO: metafield {% endcomment %}
            <span class="caption-large light">{{ block.settings.description | escape }}</span>
            {%- if show_rating and product_card_product.metafields.reviews.rating.value != blank -%}
                {% liquid
                    assign rating_decimal = 0
                    assign decimal = product_card_product.metafields.reviews.rating.value.rating | modulo: 1
                    if decimal >= 0.3 and decimal <= 0.7
                    assign rating_decimal = 0.5
                    elsif decimal > 0.7
                    assign rating_decimal = 1
                    endif %}
                <div class="rating" role="img"
                     aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: product_card_product.metafields.reviews.rating.value, rating_max: product_card_product.metafields.reviews.rating.value.scale_max }}">
                    <span aria-hidden="true" class="rating-star color-icon-{{ settings.accent_icons }}"
                          style="--rating: {{ product_card_product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ product_card_product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"></span>
                </div>
                <p class="rating-text caption">
                    <span aria-hidden="true">{{ product_card_product.metafields.reviews.rating.value }} / {{ product_card_product.metafields.reviews.rating.value.scale_max }}</span>
                </p>
                <p class="rating-count caption">
                    <span aria-hidden="true">({{ product_card_product.metafields.reviews.rating_count }})</span>
                    <span class="visually-hidden">{{ product_card_product.metafields.reviews.rating_count }} {{ "accessibility.total_reviews" | t }}</span>
                </p>
            {%- endif -%}
            {% render 'price', product: product_card_product, price_class: '' %}

        </div>
    </div>

    <div class="card card--product{% if product_card_product.featured_media == nil %} card--text-only card--soft{% endif %}{% if product_card_product.featured_media != nil and show_image_outline %} card--outline{% endif %}"
         tabindex="-1">
        <div class="card__inner">
            {%- if product_card_product.featured_media -%}
                {%- liquid
                    assign featured_media_aspect_ratio = product_card_product.featured_media.aspect_ratio

                    if product_card_product.featured_media.aspect_ratio == nil
                    assign featured_media_aspect_ratio = 1
                    endif -%}

                <div{% if add_image_padding %} class="card__media-full-spacer"{% endif %}>
                    <div class="media media--transparent media--{{ media_size }} media--hover-effect"
                            {% if media_size == 'adapt' and product_card_product.featured_media %} style="padding-bottom: {{ 1 | divided_by: featured_media_aspect_ratio | times: 100 }}%;"{% endif %}
                    >
                        <img
                                srcset="{%- if product_card_product.featured_media.width >= 165 -%}{{ product_card_product.featured_media | img_url: '165x' }} 165w,{%- endif -%}
                {%- if product_card_product.featured_media.width >= 360 -%}{{ product_card_product.featured_media | img_url: '360x' }} 360w,{%- endif -%}
                {%- if product_card_product.featured_media.width >= 533 -%}{{ product_card_product.featured_media | img_url: '533x' }} 533w,{%- endif -%}
                {%- if product_card_product.featured_media.width >= 720 -%}{{ product_card_product.featured_media | img_url: '720x' }} 720w,{%- endif -%}
                {%- if product_card_product.featured_media.width >= 940 -%}{{ product_card_product.featured_media | img_url: '940x' }} 940w,{%- endif -%}
                {%- if product_card_product.featured_media.width >= 1066 -%}{{ product_card_product.featured_media | img_url: '1066x' }} 1066w,{%- endif -%}
                {{ product_card_product.featured_media | img_url: 'master' }} {{ product_card_product.featured_media.width }}w"
                                src="{{ product_card_product.featured_media | img_url: '533x' }}"
                                sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                                alt="{{ product_card_product.featured_media.alt | escape }}"
                                loading="lazy"
                                class="motion-reduce"
                                width="{{ product_card_product.featured_media.width }}"
                                height="{{ product_card_product.featured_media.height }}"
                        >

                        {%- if product_card_product.media[1] != nil and show_secondary_image -%}
                            <img
                                    srcset="{%- if product_card_product.media[1].width >= 165 -%}{{ product_card_product.media[1] | img_url: '165x' }} 165w,{%- endif -%}
                  {%- if product_card_product.media[1].width >= 360 -%}{{ product_card_product.media[1] | img_url: '360x' }} 360w,{%- endif -%}
                  {%- if product_card_product.media[1].width >= 533 -%}{{ product_card_product.media[1] | img_url: '533x' }} 533w,{%- endif -%}
                  {%- if product_card_product.media[1].width >= 720 -%}{{ product_card_product.media[1] | img_url: '720x' }} 720w,{%- endif -%}
                  {%- if product_card_product.media[1].width >= 940 -%}{{ product_card_product.media[1] | img_url: '940x' }} 940w,{%- endif -%}
                  {%- if product_card_product.media[1].width >= 1066 -%}{{ product_card_product.media[1] | img_url: '1066x' }} 1066w,{%- endif -%}
                  {{ product_card_product.media[1] | img_url: 'master' }} {{ product_card_product.media[1].width }}w"
                                    src="{{ product_card_product.media[1] | img_url: '533x' }}"
                                    sizes="(min-width: {{ settings.page_width }}px) {{ settings.page_width | minus: 130 | divided_by: 4 }}px, (min-width: 990px) calc((100vw - 130px) / 4), (min-width: 750px) calc((100vw - 120px) / 3), calc((100vw - 35px) / 2)"
                                    alt="{{ product_card_product.media[1].alt | escape }}"
                                    loading="lazy"
                                    class="motion-reduce"
                                    width="{{ product_card_product.media[1].width }}"
                                    height="{{ product_card_product.media[1].height }}"
                            >
                        {%- endif -%}
                    </div>
                </div>
            {%- else -%}
                <div class="card__content">
                    <h2 class="card__text h3">
                        <a href="{{ product_card_product.url | default: '#' }}" class="full-unstyled-link">
                            {{ product_card_product.title }}
                        </a>
                    </h2>
                </div>
            {%- endif -%}


            <div class="card__badge">
                {%- if product_card_product.available == false -%}
                    <span class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}">{{ 'products.product.sold_out' | t }}</span>
                    {%- elsif product_card_product.compare_at_price > product_card_product.price and product_card_product.available -%}
                    <span class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}">{{ 'products.product.on_sale' | t }}</span>
                {%- endif -%}
            </div>
        </div>
    </div>
</div>

<style type="text/css">
    .el-icon-tag {
        display: inline-block;
        position: relative;
        padding: 0 12px 0 8px;
        height: 24px;
        line-height: 24px;
        color: #fff;
        font-size: 12px;
        background-color: #f57224;
    }
</style>

<div class="product-tags-wrap">
    <div class="tags-list">
        {% for tag in product_card_product.tags %}
            <a href="/collections/all/{{ tag | handleize }}">
                <span class="el-icon-tag">{{ tag }}</span>
            </a>
        {% endfor %}
    </div>
</div>

<div class="product-variant-wrap" style="background-color: #d0b28e;border-radius: 10px;margin: 10px 0;padding: 10px;">

    {%- if product_card_product.has_only_default_variant -%}
        <div>This product has no variant</div>
    {%- else -%}

        {%- for variant in product_card_product.variants -%}
            {% assign variant_quantity = 0 %}
            {% for cartLineItem in cart.items %}
                {% if cartLineItem.variant.id == variant.id %}
                    {% assign variant_quantity = cartLineItem.quantity %}
                {% endif %}
            {% endfor %}
            <div class="menu-price-wrap clearfix" style="display: inline-block; width: 100%;">
                <div class="menu-type-wrap" style="float: left; width: 50%;">
                    <div class="menu-type-price clearfix">
                        <div class="order-type">{{ variant.title }}</div>
                        <div class="menu-base-price">
                            {% render 'price', product: variant, price_class: '' %}
                        </div>
                    </div>
                </div>
                <div class="snipper-wrap" style="float: right; width: 50%;">
                    <div class="clearfix" style="text-align: right;">
                        <div class="info">
                            <input class="field__input"
                                   style="height: 30px; padding: 10px"
                                   id="{{ variant.id }}_quantity"
                                   type="text" value="{{ variant_quantity }}" disabled="disabled">
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn cart-btn next-step"
                                    data-sizeid="60713"
                                    {% if variant_quantity == 0 %}
                                        disabled="disabled"
                                    {% endif %}
                                    onclick="minusProductVariantQuantity({{ variant.id }});">
                                -
                            </button>
                            <button class="btn cart-btn qty next-step" data-qty="0"
                                    onclick="addToCart({{ variant.id }});">
                                ADD
                            </button>
                            <button type="button" class="btn cart-btn next-step"
                                    data-sizeid="60713" data-state="FROZEN"
                                    onclick="plusProductVariantQuantity({{ variant.id }});">
                                +
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        {%- endfor -%}
    {%- endif -%}
</div>


<script type="text/javascript">

    function addToCart(id) {
        addProductVariantToCart(id);
    }

    function plusProductVariantQuantity(variantID) {
        console.log('Plus quantity [' + variantID + ']');
        var currentQuantity = parseInt(jQuery('#' + variantID + '_quantity').val().trim());
        console.log('Current quantity of [' + variantID + '] = [' + currentQuantity + ']');
        if (currentQuantity > 0) {
            var updateData = {
                'id': variantID,
                'quantity': currentQuantity + 1
            };
            jQuery.post('/cart/change.js', updateData, function (data) {
                console.log(data)
                console.log('Successfully add quantity to [' + variantID + ']');
            });
        } else {
            console.log('The current quantity is 0, this action is aborted');
        }
    }

    function minusProductVariantQuantity(variantID) {
        console.log('Minus quantity [' + variantID + ']');
        var currentQuantity = parseInt(jQuery('#' + variantID + '_quantity').val().trim());
        console.log('Current quantity of [' + variantID + '] = [' + currentQuantity + ']');
        if (currentQuantity > 0) {
            jQuery.post('/cart/update.js', {
                updates: {
                    variantID: currentQuantity - 1,
                }
            });
        } else {
            console.log('The current quantity is 0, this action is aborted');
        }
    }

    function addProductVariantToCart(variantID) {

        console.log('Adding product variant [' + variantID + '] to cart...');

        // Add to cart data
        var items = {
            'items': [
                {
                    'id': parseInt(variantID),
                    'quantity': 1
                }
            ]
        };

        fetch('/cart/add.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(items)
        }).then(response => {
            alert('Successfully add product variant: [' + variantID + '] to cart !');
            return response.json();
        }).catch((error) => {
            console.error('Error:', error);
        });
    }

    function fetchDataFromCart() {
        var cartContents = fetch('/cart.js')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                return data
            });
        return false;
    }

</script>
